#!/usr/bin/env node
var mongoHandler = require('../lib/mongo-handler.js'),
  app = require('../lib/console-application.js'),
  path = require('path'),
  basename = require('basename');

//-----------------
var filename = app.getParam('-f');
var mongoHost = app.getParam('-m');
var dirname = app.getParam('-d');

if(
  (!filename && !dirname) ||
  (filename && dirname) ||
  (dirname && !mongoHost)
) {
  app.usage();
}

if(filename) {
  app.process(filename,mongoHost);
  return;
}

if(dirname) {
  var grep = require('grep1'),
    glob = require('glob'),
    sync = require('sync');

  function mygrep(input,cb) {
      grep(input, function(err, stdout, stderr) {
        cb(null,!err && !stderr);
      });
  }

  sync(function() {
    // filter for files with "FIN 103" in them
    var realdir = path.join(dirname,'*.txt');
    var files1 = glob.sync(realdir).filter( function(fn) {
      var out = mygrep.sync(null,['FIN 103',fn]);
      return out;
    });

    // get list of cached files
    mongoHandler.ls().then(function(cached) {

      // remove from this list the ones that are in the mongo db already
      var files2 = files1.filter(function(fn) {
        return cached.indexOf(basename(fn)) !== -1;
      });

      var files3 = files1.filter(function(fn) {
        return cached.indexOf(basename(fn)) === -1;
      });

      console.log("Status of files in "+realdir);
      console.log(files1.length+" files = "+files3.length+" to parse + "+files2.length+" cached");
      // handle the remaining files
      files3.map(function(fn) {
        app.process(fn,mongoHost);
      });
    });
  });
}
