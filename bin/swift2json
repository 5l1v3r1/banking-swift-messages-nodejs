#!/usr/bin/env node
var reverseMustache = require('reverse-mustache');
var fs = require('fs');
// var util = require('util');
var path = require('path');
var stringify = require('json-stable-stringify');

var bankingSwiftMessages = require('../lib/banking-swift-messages.js');
var mongoHandler = require('../lib/mongo-handler.js');

//--------------------------
// https://github.com/janl/mustache.js/blob/master/bin/mustache#L130
function usage() {
    throw new Error("Error: Usage ... swift2json -f path/to/filename.txt [-m localhost]");
}

function getFilename() {
  var fIndex = process.argv.indexOf('-f');
  if(fIndex == -1) usage();
  return process.argv.splice(fIndex, 2)[1];
}

function getCacheToMongo() {
  var mIndex = process.argv.indexOf('-m');
  if(mIndex == -1) return false;
  return process.argv.splice(mIndex, 2)[1];
}

//--------------------------
try {
  var filename = getFilename();
  var mongoHost = getCacheToMongo();

  var json = bankingSwiftMessages.parse(filename);

  if(mongoHost) {
    mongoHandler.setHost(mongoHost);
    mongoHandler.upsert(filename,json).then(function() {
      console.log("Saved to mongo the parsed json of "+filename);
    }, function(err) {
      console.error(err.stack);
      process.exit(255); // 255 is selected for xargs http://stackoverflow.com/a/26485626/4126114
    });
    return;
  }

  // output sorted keys
  // https://www.npmjs.com/package/json-stable-stringify
  // THIS IS NOT SORTED: console.log(util.inspect(parsed,false,null));
  console.log(stringify(json,{space:4}));

} catch(err) {
    console.error(err); 
    process.exit(1);
}

